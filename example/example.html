<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>TradingView WebSocket Example - tvws</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                font-weight: bold;
            }
            .success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .error {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .info {
                background-color: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
            .warning {
                background-color: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }
            button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background-color: #0056b3;
            }
            button:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
            }
            .results {
                margin-top: 20px;
                padding: 15px;
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
            }
            .candle-item {
                font-family: monospace;
                font-size: 14px;
                margin: 5px 0;
                padding: 8px;
                background: white;
                border-radius: 4px;
                border-left: 4px solid #007bff;
            }
            #log {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                padding: 10px;
                font-family: monospace;
                font-size: 12px;
                max-height: 200px;
                overflow-y: auto;
                white-space: pre-wrap;
            }
            .endpoint-selector {
                margin: 15px 0;
                padding: 10px;
                background-color: #e9ecef;
                border-radius: 4px;
            }
            .endpoint-selector select {
                padding: 5px;
                margin: 0 10px;
                border-radius: 4px;
                border: 1px solid #ced4da;
            }
            .auth-section {
                margin: 15px 0;
                padding: 15px;
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
            }
            .auth-toggle {
                margin-bottom: 10px;
            }
            .auth-input {
                display: flex;
                align-items: center;
                gap: 10px;
                margin: 10px 0;
            }
            .auth-status {
                font-size: 14px;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>TradingView WebSocket Example - tvws</h1>
            <p><strong>Package:</strong> tvws (Browser Compatible Version)</p>

            <div class="endpoint-selector">
                <label for="endpointSelect">WebSocket Endpoint:</label>
                <select
                    id="endpointSelect"
                    onchange="log('Selected endpoint: ' + this.value, 'info')"
                >
                    <option value="data">
                        data (Free Users - Recommended)
                    </option>
                    <option value="prodata">prodata (Premium Users)</option>
                    <option value="widgetdata">widgetdata (Widget Data)</option>
                    <option value="charts-polygon">
                        charts-polygon (Polygon Data)
                    </option>
                </select>
            </div>

            <div class="auth-section">
                <h3>üîê Authentication (Optional)</h3>
                <div class="auth-toggle">
                    <label>
                        <input
                            type="checkbox"
                            id="authToggle"
                            onchange="toggleAuthFields()"
                        />
                        Use Authentication (Session ID)
                    </label>
                </div>
                <div id="authFields" style="display: none">
                    <div class="auth-input">
                        <label for="sessionId">Session ID:</label>
                        <input
                            type="text"
                            id="sessionId"
                            placeholder="Enter your TradingView session ID"
                            style="
                                width: 300px;
                                padding: 5px;
                                margin: 5px;
                                border-radius: 4px;
                                border: 1px solid #ced4da;
                            "
                        />
                        <button
                            onclick="showSessionHelp()"
                            style="padding: 5px 10px; font-size: 12px"
                        >
                            ?
                        </button>
                    </div>
                    <div
                        class="auth-status"
                        id="authStatus"
                        style="
                            margin: 10px 0;
                            padding: 8px;
                            border-radius: 4px;
                            display: none;
                        "
                    >
                        <!-- Auth status will be displayed here -->
                    </div>
                </div>
                <div
                    id="sessionHelp"
                    style="
                        display: none;
                        margin: 10px 0;
                        padding: 10px;
                        background-color: #f8f9fa;
                        border-radius: 4px;
                        border: 1px solid #dee2e6;
                    "
                >
                    <h4>üìã How to Find Your Session ID:</h4>
                    <ol>
                        <li>
                            Log into TradingView (<a
                                href="https://www.tradingview.com"
                                target="_blank"
                                >www.tradingview.com</a
                            >)
                        </li>
                        <li>Open browser developer tools (F12)</li>
                        <li>
                            Go to <strong>Application</strong> tab ‚Üí
                            <strong>Cookies</strong> ‚Üí
                            <strong>https://www.tradingview.com</strong>
                        </li>
                        <li>Find the cookie named <code>sessionid</code></li>
                        <li>
                            Copy the value (it's a long alphanumeric string)
                        </li>
                    </ol>
                    <p>
                        <strong>Note:</strong> Due to browser CORS restrictions,
                        authentication may not work in all browsers. If it
                        fails, the system will automatically fall back to
                        unauthorized access.
                    </p>
                    <button
                        onclick="hideSessionHelp()"
                        style="
                            padding: 5px 10px;
                            font-size: 12px;
                            margin-top: 10px;
                        "
                    >
                        Hide Help
                    </button>
                </div>
            </div>

            <div id="status" class="status info">
                Ready to test TradingView WebSocket connection...
            </div>

            <div>
                <button
                    id="quickConnectBtn"
                    onclick="quickConnect()"
                    style="background-color: #28a745; margin-right: 10px"
                >
                    üöÄ Quick Connect (No Auth)
                </button>
                <button id="connectBtn" onclick="testConnection()">
                    Connect to TradingView
                </button>
                <button id="clearBtn" onclick="clearResults()">
                    Clear Results
                </button>
                <button id="clearLogBtn" onclick="clearLog()">Clear Log</button>
            </div>

            <!-- Custom K-Line Query Interface -->
            <div
                class="kline-query-section"
                style="
                    margin-top: 20px;
                    padding: 15px;
                    background-color: #f8f9fa;
                    border: 1px solid #dee2e6;
                    border-radius: 4px;
                "
            >
                <h3>üìä K-Line Query Configuration</h3>

                <!-- Ticker Symbol Input -->
                <div style="margin: 10px 0">
                    <label
                        for="tickerInput"
                        style="
                            display: block;
                            margin-bottom: 5px;
                            font-weight: bold;
                        "
                    >
                        Ticker Symbol:
                    </label>
                    <input
                        type="text"
                        id="tickerInput"
                        placeholder="e.g., BINANCE:BTCUSDT.P, FX:EURUSD, NASDAQ:AAPL"
                        value="FX:EURUSD"
                        style="
                            width: 300px;
                            padding: 8px;
                            border-radius: 4px;
                            border: 1px solid #ced4da;
                            margin-right: 10px;
                        "
                    />
                    <select
                        id="tickerPreset"
                        onchange="selectPresetTicker()"
                        style="
                            padding: 8px;
                            border-radius: 4px;
                            border: 1px solid #ced4da;
                        "
                    >
                        <option value="">Quick Select Ticker...</option>
                        <optgroup label="Crypto">
                            <option value="BINANCE:BTCUSDT.P">
                                BINANCE:BTCUSDT.P
                            </option>
                            <option value="BINANCE:ETHUSDT.P">
                                BINANCE:ETHUSDT.P
                            </option>
                            <option value="BINANCE:ADAUSDT.P">
                                BINANCE:ADAUSDT.P
                            </option>
                            <option value="BINANCE:SOLUSDT.P">
                                BINANCE:SOLUSDT.P
                            </option>
                            <option value="CRYPTO:BTCUSD">CRYPTO:BTCUSD</option>
                            <option value="CRYPTO:ETHUSD">CRYPTO:ETHUSD</option>
                        </optgroup>
                        <optgroup label="Forex">
                            <option value="FX:EURUSD">FX:EURUSD</option>
                            <option value="FX:GBPUSD">FX:GBPUSD</option>
                            <option value="FX:USDJPY">FX:USDJPY</option>
                            <option value="FX:AUDUSD">FX:AUDUSD</option>
                            <option value="FX:USDCAD">FX:USDCAD</option>
                        </optgroup>
                        <optgroup label="Stocks">
                            <option value="NASDAQ:AAPL">NASDAQ:AAPL</option>
                            <option value="NASDAQ:GOOGL">NASDAQ:GOOGL</option>
                            <option value="NASDAQ:MSFT">NASDAQ:MSFT</option>
                            <option value="NYSE:TSLA">NYSE:TSLA</option>
                            <option value="NYSE:GME">NYSE:GME</option>
                        </optgroup>
                        <optgroup label="Indices">
                            <option value="INDEX:SPX">
                                INDEX:SPX (S&P 500)
                            </option>
                            <option value="INDEX:DJI">
                                INDEX:DJI (Dow Jones)
                            </option>
                            <option value="INDEX:IXIC">
                                INDEX:IXIC (NASDAQ)
                            </option>
                            <option value="INDEX:VIX">
                                INDEX:VIX (Volatility)
                            </option>
                        </optgroup>
                    </select>
                </div>

                <!-- Timeframe and Amount Selection -->
                <div
                    style="
                        display: flex;
                        gap: 15px;
                        margin: 10px 0;
                        align-items: center;
                    "
                >
                    <div>
                        <label
                            for="timeframeSelect"
                            style="
                                display: block;
                                margin-bottom: 5px;
                                font-weight: bold;
                            "
                        >
                            Timeframe:
                        </label>
                        <select
                            id="timeframeSelect"
                            style="
                                padding: 8px;
                                border-radius: 4px;
                                border: 1px solid #ced4da;
                            "
                        >
                            <option value="1m">1 Minute</option>
                            <option value="3m">3 Minutes</option>
                            <option value="5m">5 Minutes</option>
                            <option value="15m">15 Minutes</option>
                            <option value="30m">30 Minutes</option>
                            <option value="45m">45 Minutes</option>
                            <option value="1h">1 Hour</option>
                            <option value="2h">2 Hours</option>
                            <option value="3h">3 Hours</option>
                            <option value="4h">4 Hours</option>
                            <option value="1D" selected>1 Day</option>
                            <option value="1W">1 Week</option>
                            <option value="1M">1 Month</option>
                        </select>
                    </div>

                    <div>
                        <label
                            for="amountInput"
                            style="
                                display: block;
                                margin-bottom: 5px;
                                font-weight: bold;
                            "
                        >
                            Number of K-Lines:
                        </label>
                        <input
                            type="number"
                            id="amountInput"
                            min="1"
                            max="500"
                            value="10"
                            style="
                                width: 80px;
                                padding: 8px;
                                border-radius: 4px;
                                border: 1px solid #ced4da;
                            "
                        />
                    </div>

                    <div>
                        <label
                            for="extendedDataCheck"
                            style="
                                display: block;
                                margin-bottom: 5px;
                                font-weight: bold;
                            "
                        >
                            Extended Data:
                        </label>
                        <label
                            style="display: flex; align-items: center; gap: 5px"
                        >
                            <input
                                type="checkbox"
                                id="extendedDataCheck"
                                style="margin: 0"
                            />
                            <span style="font-size: 12px"
                                >Include additional details</span
                            >
                        </label>
                    </div>
                </div>

                <!-- Fetch Button -->
                <div style="margin-top: 15px">
                    <button
                        id="candlesBtn"
                        onclick="loadData()"
                        disabled
                        style="background-color: #007bff"
                    >
                        üìä Get K-Line Data
                    </button>
                    <button
                        onclick="resetQueryForm()"
                        style="background-color: #6c757d; margin-left: 5px"
                    >
                        üîÑ Reset Form
                    </button>
                </div>
            </div>

            <div id="results" class="results" style="display: none">
                <h3 id="resultsTitle">K-Line Data</h3>
                <div
                    id="queryInfo"
                    style="
                        margin-bottom: 10px;
                        padding: 8px;
                        background-color: #e9ecef;
                        border-radius: 4px;
                        font-size: 14px;
                    "
                ></div>
                <div id="candleData"></div>
            </div>

            <h3>Debug Log:</h3>
            <div id="log"></div>
        </div>

        <script type="module">
            // Use CDN for easy testing - works in any browser
            import {
                connect,
                getCandles,
                ENDPOINTS,
            } from "https://unpkg.com/tvws@latest/dist/index.js";

            let connection = null;

            // Authentication helper functions
            window.toggleAuthFields = function () {
                const authToggle = document.getElementById("authToggle");
                const authFields = document.getElementById("authFields");

                if (authToggle.checked) {
                    authFields.style.display = "block";
                    log(
                        "Authentication enabled - please enter your session ID",
                        "info",
                    );
                } else {
                    authFields.style.display = "none";
                    hideAuthStatus();
                    log(
                        "Authentication disabled - will use unauthorized access",
                        "info",
                    );
                }
            };

            window.showSessionHelp = function () {
                document.getElementById("sessionHelp").style.display = "block";
            };

            window.hideSessionHelp = function () {
                document.getElementById("sessionHelp").style.display = "none";
            };

            function showAuthStatus(message, type) {
                const authStatus = document.getElementById("authStatus");
                authStatus.textContent = message;
                authStatus.className = `auth-status status ${type}`;
                authStatus.style.display = "block";
            }

            function hideAuthStatus() {
                document.getElementById("authStatus").style.display = "none";
            }

            function getAuthOptions() {
                const authToggle = document.getElementById("authToggle");
                const sessionId = document
                    .getElementById("sessionId")
                    .value.trim();

                if (authToggle.checked && sessionId) {
                    return { sessionId: sessionId };
                }
                return {};
            }

            // Quick Connect function - bypasses all options and uses most reliable settings
            window.quickConnect = async function () {
                const quickConnectBtn =
                    document.getElementById("quickConnectBtn");
                const connectBtn = document.getElementById("connectBtn");
                const candlesBtn = document.getElementById("candlesBtn");

                quickConnectBtn.disabled = true;
                quickConnectBtn.textContent = "Quick Connecting...";
                connectBtn.disabled = true;

                updateStatus(
                    "Quick connecting to most reliable endpoint...",
                    "info",
                );

                log("=== Quick Connect Started ===", "info");
                log("Using: data endpoint (most reliable)", "info");
                log("Authentication: DISABLED", "info");
                log(
                    "WebSocket URL: https://data.tradingview.com/socket.io/websocket",
                    "info",
                );

                try {
                    connection = await connect({
                        endpoint: "data",
                        // No authentication - use unauthorized access
                    });

                    log("‚úÖ Quick connection successful!", "success");
                    log(
                        "üéâ Connected to TradingView - Ready to fetch data",
                        "success",
                    );
                    showAuthStatus(
                        "‚úÖ Quick Connect successful - using public data",
                        "success",
                    );

                    updateStatus(
                        "Quick Connect successful! Ready to fetch data.",
                        "success",
                    );

                    // Enable data button
                    candlesBtn.disabled = false;
                    quickConnectBtn.textContent = "‚úÖ Quick Connected";
                    connectBtn.textContent = "Connected";

                    // Subscribe to real-time events
                    connection.subscribe((event) => {
                        log(`üì° Real-time event: ${event.name}`, "info");
                    });
                } catch (error) {
                    const errorMessage =
                        error?.message ||
                        error?.toString() ||
                        "Unknown error occurred";
                    log(`‚ùå Quick Connect failed: ${errorMessage}`, "error");
                    log(
                        `Error details: ${JSON.stringify(error, null, 2)}`,
                        "info",
                    );

                    log("Quick Connect troubleshooting:", "warning");
                    log("- Check your internet connection", "warning");
                    log(
                        "- Try refreshing the page and trying again",
                        "warning",
                    );
                    log(
                        "- Some networks block WebSocket connections",
                        "warning",
                    );
                    log(
                        "- TradingView may be temporarily unavailable",
                        "warning",
                    );

                    updateStatus(
                        `Quick Connect failed: ${errorMessage}`,
                        "error",
                    );
                    quickConnectBtn.disabled = false;
                    quickConnectBtn.textContent = "üöÄ Quick Connect (No Auth)";
                    connectBtn.disabled = false;
                }
            };

            // Make functions globally available
            window.testConnection = async function () {
                const connectBtn = document.getElementById("connectBtn");
                const candlesBtn = document.getElementById("candlesBtn");
                const selectedEndpoint =
                    document.getElementById("endpointSelect").value;
                const authOptions = getAuthOptions();

                connectBtn.disabled = true;
                connectBtn.textContent = "Connecting...";
                updateStatus(
                    `Connecting to ${selectedEndpoint} endpoint...`,
                    "info",
                );

                log("=== Connection Test Started ===", "info");
                log(`Endpoint: ${selectedEndpoint}`);
                log(`WebSocket URL: ${ENDPOINTS[selectedEndpoint]}`);

                try {
                    connection = await connect({
                        endpoint: selectedEndpoint,
                    });

                    log("‚úÖ WebSocket connection established!", "success");

                    if (authOptions.sessionId) {
                        showAuthStatus(
                            "‚úÖ Authentication successful!",
                            "success",
                        );
                        log(
                            "üéâ Authentication successful - premium data may be available",
                            "success",
                        );
                    } else {
                        showAuthStatus(
                            "‚úÖ Connected with unauthorized access",
                            "warning",
                        );
                        log(
                            "‚ö†Ô∏è Connected without authentication - using public data",
                            "warning",
                        );
                    }

                    updateStatus(
                        "Connected successfully! Ready to fetch data.",
                        "success",
                    );

                    // Enable data button
                    candlesBtn.disabled = false;
                    connectBtn.textContent = "Connected";

                    // Subscribe to real-time events
                    connection.subscribe((event) => {
                        log(`üì° Real-time event: ${event.name}`, "info");
                    });
                } catch (error) {
                    // Extract proper error message
                    const errorMessage =
                        error?.message ||
                        error?.toString() ||
                        "Unknown error occurred";
                    log(`‚ùå Connection failed: ${errorMessage}`, "error");
                    log(
                        `Error details: ${JSON.stringify(error, null, 2)}`,
                        "info",
                    );

                    if (authOptions.sessionId) {
                        log(
                            "üîê Authentication failed - possible reasons:",
                            "warning",
                        );
                        log("- Session ID expired or invalid", "warning");
                        log(
                            "- CORS restrictions blocked authentication",
                            "warning",
                        );
                        log("- Browser security policies", "warning");
                        log(
                            "Try again without authentication or refresh your session ID",
                            "info",
                        );
                        showAuthStatus(
                            "‚ùå Authentication failed - try without auth or check session ID",
                            "error",
                        );
                    } else {
                        log("Connection failed - possible reasons:", "warning");
                        log("- Network connectivity issues", "warning");
                        log(
                            "- WebSocket blocked by browser/security policy",
                            "warning",
                        );
                        log(
                            "- TradingView endpoint temporarily unavailable",
                            "warning",
                        );
                        log(
                            "Solution: Try a different endpoint or check your internet connection",
                            "info",
                        );
                    }

                    updateStatus(
                        `Connection failed: ${error.message}`,
                        "error",
                    );
                    connectBtn.disabled = false;
                    connectBtn.textContent = "Connect to TradingView";
                }
            };

            window.loadData = async function () {
                if (!connection) {
                    log(
                        "‚ùå No active connection. Please connect first.",
                        "error",
                    );
                    return;
                }

                // Get custom parameters from the form
                const ticker = document
                    .getElementById("tickerInput")
                    .value.trim();
                const timeframe =
                    document.getElementById("timeframeSelect").value;
                const amount = parseInt(
                    document.getElementById("amountInput").value,
                );
                const extendedData =
                    document.getElementById("extendedDataCheck").checked;
                const selectedEndpoint =
                    document.getElementById("endpointSelect").value;

                // Validate inputs
                if (!ticker) {
                    log("‚ùå Please enter a ticker symbol", "error");
                    updateStatus("Please enter a ticker symbol", "error");
                    return;
                }

                // Validate symbol/timeframe combination
                const validation = validateSymbolTimeframe(
                    ticker,
                    timeframe,
                    selectedEndpoint,
                );
                if (validation.issues.length > 0) {
                    log("‚ö†Ô∏è Potential Issues Detected:", "warning");
                    validation.issues.forEach((issue) =>
                        log(`- ${issue}`, "warning"),
                    );
                    log("üí° Suggestions:", "info");
                    validation.suggestions.forEach((suggestion) =>
                        log(`- ${suggestion}`, "info"),
                    );
                    log("Proceeding anyway...", "info");
                }

                if (amount < 1 || amount > 500) {
                    log(
                        "‚ùå Number of K-Lines must be between 1 and 500",
                        "error",
                    );
                    updateStatus("Invalid number of K-Lines", "error");
                    return;
                }

                const candlesBtn = document.getElementById("candlesBtn");
                const resultsDiv = document.getElementById("results");
                const candleDataDiv = document.getElementById("candleData");
                const resultsTitle = document.getElementById("resultsTitle");
                const queryInfo = document.getElementById("queryInfo");

                candlesBtn.disabled = true;
                candlesBtn.textContent = "Loading...";

                // Update UI to show what we're fetching
                const timeframeText = getTimeframeText(timeframe);
                resultsTitle.textContent = `${ticker} K-Line Data (${timeframeText})`;
                updateStatus(
                    `Fetching ${ticker} data (${timeframeText})...`,
                    "info",
                );

                log("=== Data Fetch Started ===", "info");
                log(`Symbol: ${ticker}`);
                log(`Timeframe: ${timeframe} (${timeframeText})`);
                log(`Amount: ${amount} candles`);
                log(`Extended Data: ${extendedData ? "Enabled" : "Disabled"}`);
                log(`Endpoint: ${selectedEndpoint}`);

                try {
                    const candles = await getCandles({
                        connection,
                        symbols: [ticker],
                        amount: amount,
                        timeframe: timeframe,
                    });

                    if (candles.length > 0 && candles[0].length > 0) {
                        log(
                            `‚úÖ Successfully retrieved ${candles[0].length} candles`,
                            "success",
                        );

                        // Display query info
                        queryInfo.innerHTML = `
                            <strong>Query Parameters:</strong>
                            Symbol: <code>${ticker}</code> |
                            Timeframe: <code>${timeframe}</code> |
                            Candles: <code>${amount}</code> |
                            Received: <code>${candles[0].length}</code> |
                            Endpoint: <code>${selectedEndpoint}</code>
                        `;

                        // Display candle data
                        candleDataDiv.innerHTML = "";
                        candles[0].forEach((candle, index) => {
                            const date = new Date(candle.timestamp * 1000);
                            const candleEl = document.createElement("div");
                            candleEl.className = "candle-item";

                            let candleHtml = `
                                <strong>Candle ${index + 1}:</strong> ${date.toLocaleString()} |
                                Open: ${candle.open.toFixed(5)} |
                                High: ${candle.high.toFixed(5)} |
                                Low: ${candle.low.toFixed(5)} |
                                Close: ${candle.close.toFixed(5)} |
                                Volume: ${candle.volume}
                            `;

                            // Add extended data if enabled
                            if (extendedData && candle.vwap !== undefined) {
                                candleHtml += ` | VWAP: ${candle.vwap.toFixed(5)}`;
                            }
                            if (extendedData && candle.trades !== undefined) {
                                candleHtml += ` | Trades: ${candle.trades}`;
                            }

                            candleEl.innerHTML = candleHtml;
                            candleDataDiv.appendChild(candleEl);
                        });

                        resultsDiv.style.display = "block";
                        updateStatus(
                            `‚úÖ ${ticker} data loaded successfully!`,
                            "success",
                        );
                        log("‚úÖ Data displayed in results section", "success");

                        // Log price statistics
                        const closes = candles[0].map((c) => c.close);
                        const lastPrice = closes[closes.length - 1];
                        const firstPrice = closes[0];
                        const change = (
                            ((lastPrice - firstPrice) / firstPrice) *
                            100
                        ).toFixed(2);
                        const high = Math.max(...candles[0].map((c) => c.high));
                        const low = Math.min(...candles[0].map((c) => c.low));

                        log(`üìä Price Summary:`, "info");
                        log(`   Last Price: ${lastPrice.toFixed(5)}`, "info");
                        log(
                            `   Change: ${change}%`,
                            change >= 0 ? "success" : "warning",
                        );
                        log(`   High: ${high.toFixed(5)}`, "info");
                        log(`   Low: ${low.toFixed(5)}`, "info");
                    } else {
                        log(
                            "‚ö†Ô∏è No data received - possible reasons:",
                            "warning",
                        );
                        log(
                            "- Symbol not available on this endpoint",
                            "warning",
                        );
                        log(
                            "- Insufficient data for requested timeframe",
                            "warning",
                        );
                        log(
                            "- Symbol may be delisted or temporarily unavailable",
                            "warning",
                        );
                        log("- Try a different symbol or endpoint", "info");
                        updateStatus(
                            `No data available for ${ticker}.`,
                            "warning",
                        );
                    }
                } catch (error) {
                    const errorMessage =
                        error?.message ||
                        error?.toString() ||
                        "Unknown error occurred";
                    log(`‚ùå Data fetch failed: ${errorMessage}`, "error");
                    log("Troubleshooting tips:", "warning");

                    // Specific troubleshooting based on error type
                    if (
                        errorMessage.includes("critical_error") ||
                        errorMessage.includes("error")
                    ) {
                        log("üö® Critical Error Detected:", "error");
                        log(
                            "- This usually means the symbol/timeframe is not supported",
                            "error",
                        );
                        log("- Try these solutions:", "info");
                        log(
                            "  ‚Ä¢ Use daily timeframe (1D) for crypto symbols",
                            "info",
                        );
                        log(
                            "  ‚Ä¢ Try forex symbols for intraday data (FX:EURUSD)",
                            "info",
                        );
                        log(
                            "  ‚Ä¢ Use prodata endpoint if you have premium access",
                            "info",
                        );
                        log(
                            "  ‚Ä¢ Try different crypto symbols (CRYPTO:BTCUSD)",
                            "info",
                        );
                    } else {
                        log(
                            "- Check if the ticker symbol is correct",
                            "warning",
                        );
                        log(
                            "- Try a different timeframe (1D usually works)",
                            "warning",
                        );
                        log(
                            "- Some symbols require specific endpoints",
                            "warning",
                        );
                        log(
                            "- Check if the market is currently open for this symbol",
                            "warning",
                        );
                    }

                    updateStatus(
                        `Failed to fetch data: ${errorMessage}`,
                        "error",
                    );
                } finally {
                    // Always re-enable the button, regardless of success or failure
                    candlesBtn.disabled = false;
                    candlesBtn.textContent = "üìä Get K-Line Data";
                    log("=== Data Fetch Completed ===", "info");
                    log(
                        "üîÑ You can try different settings and fetch again",
                        "info",
                    );
                }
            };

            // Helper function to get readable timeframe text
            function getTimeframeText(timeframe) {
                const timeframeMap = {
                    "1m": "1 Minute",
                    "3m": "3 Minutes",
                    "5m": "5 Minutes",
                    "15m": "15 Minutes",
                    "30m": "30 Minutes",
                    "45m": "45 Minutes",
                    "1h": "1 Hour",
                    "2h": "2 Hours",
                    "3h": "3 Hours",
                    "4h": "4 Hours",
                    "1D": "1 Day",
                    "1W": "1 Week",
                    "1M": "1 Month",
                };
                return timeframeMap[timeframe] || timeframe;
            }

            // Function to validate if symbol/timeframe combination is likely to work
            function validateSymbolTimeframe(ticker, timeframe, endpoint) {
                const issues = [];
                const suggestions = [];

                // Check for common crypto intraday limitations
                if (ticker.includes("BINANCE:") || ticker.includes("CRYPTO:")) {
                    if (
                        ["1m", "3m", "5m", "15m", "30m", "45m"].includes(
                            timeframe,
                        )
                    ) {
                        if (endpoint === "data") {
                            issues.push(
                                "Crypto intraday data may not be available on free endpoint",
                            );
                            suggestions.push("Try timeframe: 1h, 4h, or 1D");
                            suggestions.push(
                                "Or try endpoint: prodata (requires premium)",
                            );
                        }
                    }
                }

                // Check for stock market hours issues
                if (ticker.includes("NASDAQ:") || ticker.includes("NYSE:")) {
                    const now = new Date();
                    const day = now.getDay();
                    const hour = now.getHours();

                    if (day === 0 || day === 6) {
                        issues.push("Stock markets are closed on weekends");
                        suggestions.push(
                            "Try during market hours (Mon-Fri, 9:30 AM - 4:00 PM EST)",
                        );
                    } else if (hour < 10 || hour > 16) {
                        issues.push(
                            "Stock markets may be closed (outside 9:30 AM - 4:00 PM EST)",
                        );
                        suggestions.push(
                            "Try during market hours or use daily timeframe (1D)",
                        );
                    }
                }

                return { issues, suggestions };
            }

            window.clearResults = function () {
                document.getElementById("results").style.display = "none";
                document.getElementById("candleData").innerHTML = "";
                updateStatus("Results cleared.", "info");
                log("Results cleared", "info");
            };

            window.clearLog = function () {
                document.getElementById("log").textContent = "";
            };

            // New functions for custom K-Line query interface
            window.selectPresetTicker = function () {
                const preset = document.getElementById("tickerPreset").value;
                if (preset) {
                    document.getElementById("tickerInput").value = preset;
                    log(`Selected preset ticker: ${preset}`, "info");
                }
            };

            window.resetQueryForm = function () {
                document.getElementById("tickerInput").value = "FX:EURUSD";
                document.getElementById("tickerPreset").value = "";
                document.getElementById("timeframeSelect").value = "1D";
                document.getElementById("amountInput").value = "10";
                document.getElementById("extendedDataCheck").checked = false;
                log("Query form reset to default values", "info");
            };

            function updateStatus(message, type = "info") {
                const statusEl = document.getElementById("status");
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            }

            function log(message, type = "info") {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                console.log(logMessage);

                const logEl = document.getElementById("log");
                logEl.textContent += logMessage + "\n";
                logEl.scrollTop = logEl.scrollHeight;
            }

            // Make log function globally available for HTML handlers
            window.log = log;

            // Initialize
            log("TradingView WebSocket Example loaded", "success");
            log("Package: tvws (Browser Compatible)", "info");
            log(
                "Imported from: https://unpkg.com/tvws@latest/dist/index.js",
                "info",
            );
            log("Ready to connect!", "success");
            log("", "info");
            log("=== Instructions ===", "info");
            log("üöÄ QUICK START:", "info");
            log(
                '1. Click "üöÄ Quick Connect (No Auth)" - bypasses all settings',
                "info",
            );
            log("2. Configure your K-Line query below", "info");
            log('3. Click "üìä Get K-Line Data" once connected', "info");
            log("", "info");
            log("=== Advanced Options ===", "info");
            log("1. Select a WebSocket endpoint (recommended: data)", "info");
            log(
                "2. Optional: Enable authentication and enter your session ID",
                "info",
            );
            log('3. Click "Connect to TradingView"', "info");
            log("4. Configure your query parameters in the form below", "info");
            log('5. Click "üìä Get K-Line Data" once connected', "info");
            log("", "info");
            log("üìä K-Line Query Features:", "info");
            log(
                "- Custom ticker symbols (e.g., BINANCE:BTCUSDT.P, FX:EURUSD)",
                "info",
            );
            log("- Multiple timeframes: 1m to 1M", "info");
            log("- Adjustable number of candles (1-500)", "info");
            log("- Quick selection from popular tickers", "info");
            log("- Extended data option (VWAP, trades)", "info");
            log("- Price statistics and change calculations", "info");
            log("", "info");
            log("üí° Tips:", "info");
            log("- Use Quick Connect for fastest connection testing", "info");
            log(
                "- The system will automatically try fallback endpoints",
                "info",
            );
            log(
                "- Authentication provides access to premium data but may fail due to CORS",
                "info",
            );
            log("- If anything fails, try Quick Connect first", "info");
            log("- Try different timeframes if data is unavailable", "info");
            log("- Some symbols may require specific endpoints", "info");
            log("", "info");
            log("üîç Popular Ticker Formats:", "info");
            log("- Crypto: BINANCE:BTCUSDT.P, CRYPTO:BTCUSD", "info");
            log("- Forex: FX:EURUSD, FX:GBPUSD", "info");
            log("- Stocks: NASDAQ:AAPL, NYSE:TSLA", "info");
            log("- Indices: INDEX:SPX, INDEX:DJI", "info");
            log("", "info");
        </script>
    </body>
</html>
